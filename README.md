# Sbermarket_hackaton
## Планирование рабочих смен для курьеров на 7 дней вперёд
### План решения подразумевал разбиение задачи на 3 задачи:
    1. Предсказание количества заказов в час
    2. Подсчёт необходимого количества курьеров в час
    3. Распределение курьерских смен
#### Задача 1
###### Из таблицы orders.csv были выделены следующие признаки и использованные в ML модели:
    1. year - год
    2. month - месяц
    3. day - день
    4. weekday - день недели
    5. week_number - номер недели
    6. days_nearest_holiday - количество дней до ближайшего праздника
    7. sum_per_1_week - количество заказов за эту неделю (нормированное на медианное значение заказов за прошлую неделю в день) 
    8. sum_per_2_weeks - количество закзов за эту и прошлую недели (нормированное на медианное значение заказов за прошлую неделю в день) 
    9. sum_per_3_weeks - количество заказов за эту и 2 прошлые недели (нормированное на медианное значение заказов за прошлую неделю в день) 
    10. median_for_prev_week - медиана за прошлую неделю
    11. delivery_area_id - номер зоны доставки

Использованные методы для каждого дня находились гридом:
grid = {'learning_rate': [0.03, 0.1],
        'depth': [3, 5, 7, 9],
        'l2_leaf_reg': [ 3, 5, 7],
        'n_estimators': [100, 500, 2000],
        'loss_function': ['MAPE', 'RMSE']}
        
Предсказываем norm_orders_per_day - количество заказов нормированное на медиану предыдущей недели. 
В дальнейшем домножаем это значение на медиану и округляем до целого. 
Далее перемножаем полученные данные для дней на таблицу распределения заказов в днях по часам.
Строим таблицу заказов по часам из полученных моделей.
    
    
#### Задача 2 
###### Для второй задачи были выделены следующие признаки: 
    1. delivery_area_id  - область доставки 
    2. partners_cnt  - количество курьеров
    3. orders_cnt  -количество заказов
    4. perc  - отношение количества заказов к количеству курьеров 
    5. weekday  - день недели
    6. times_of_day - время дня (утро - 0, день  - 1, вечер - 2, ночь - 3)
    
Предсказываем delay_rate - опоздание.

###### Для предсказания была выбрана модель градиентного бустинга (CatBoostRegressor) с параметрами:

params = {'loss_function': 'MAPE',
          'depth': 6,
          'l2_leaf_reg': 1,
          'iterations': 1000,
          'learning_rate': 0.01}
          
которые подбирались гридом.
На исходной таблице MAPE было ~ 0.2 - 0.3

После этого из данных из первой задачи генерировалась таблица, где для каждой строчки с количеством заказов в час приписывалось различное количество курьеров. По этим данным модель предсказывала опоздания. Далее удалялись все строчки, у которых значения опоздания >0.05 и выбиралось минимальное количество курьеров из оставшихся (для каждого часа в каждой области)

#### Задача 3

###### Для решения 3 задачи использовался симплекс метод (линейное программирование). 
    1. Матрица  A - всевозможные смены
    2. h -  необходимое количество курьеров в час
    3. c = 1, ..., 1
  
###### По итогу получаем список словарей : 
    1. индекс списка - номер области (0 - 592) 
    2. ключ словаря - дата (в формате '2021-09-22')
    3. значение - список из двух элементов: 1 - час, с которого начинаются смены; 2 - список списков (матрица), в которой по строкам смены и в каждой смене указано в какие часы от начала заказов в этот день она есть (1 -работает, 0 - нет)
    
### Результаты: 
Для примера приведем 3 гистограммы с распределением смен

![Image text](https://github.com/IrinaKarmatskikh/CMF_hackathon_workshifts/blob/main/images/gist_1.png)
![Image text](https://github.com/IrinaKarmatskikh/CMF_hackathon_workshifts/blob/main/images/gist_2.png)
![Image text](https://github.com/IrinaKarmatskikh/CMF_hackathon_workshifts/blob/main/images/gist_3.png)

